# åœ¨Swiftä¸­ç¼–å†™è„šæœ¬ï¼šGit Hooks

> [åŸæ–‡åœ°å€](https://www.polpiella.dev/scripting-in-swift-git-hooks#retrieving-the-ticket-number)

è¿™å‘¨ï¼Œæˆ‘å†³å®šå®Œæˆå› ä¸ºå·¥ä½œè€Œæ¨è¿Ÿäº†ä¸€å‘¨çš„TODOäº‹é¡¹æ¥æ”¹è¿›æˆ‘çš„Gitå·¥ä½œæµç¨‹ã€‚

ä¸ºäº†åœ¨æäº¤çš„æ—¶å€™å°½å¯èƒ½å¤šçš„æºå¸¦ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæˆ‘ä»¬è®©æäº¤ä¿¡æ¯åŒ…å«äº†æ­£åœ¨å¤„ç†çš„JIRAç¼–å·ã€‚è¿™æ ·ï¼Œå°†æ¥å¦‚æœæœ‰äººå›åˆ°æˆ‘ä»¬ç°åœ¨æ­£åœ¨æäº¤çš„æºä»£ç ï¼Œè¾“å…¥`git blame`ï¼Œå°±èƒ½å¾ˆå®¹æ˜“çš„æ‰¾å‡ºJIRAçš„ç¼–å·ã€‚

æ¯æ¬¡æäº¤éƒ½åŒ…å«è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šæœ‰ç‚¹ä¹å‘³ï¼ˆå¦‚æœä½ ä½¿ç”¨äº†ç±»ä¼¼[TDD](https://en.wikipedia.org/wiki/Test-driven_development)ä¹‹ç±»çš„æ–¹æ³•ï¼Œæ‚¨ä¼šæäº¤çš„æ›´åŠ é¢‘ç¹ï¼‰ï¼Œè€Œä¸”ï¼Œå°½ç®¡åƒ[Tower](https://www.git-tower.com/mac)è¿™æ ·çš„gitå®¢æˆ·ç«¯ä¼šè®©æ­¤å˜å¾—å®¹æ˜“ä¸€äº›ï¼Œä½†æ˜¯æ‚¨ä»ç„¶éœ€è¦æ‰‹åŠ¨å°†é—®é¢˜ç¼–å·å¤åˆ¶ç²˜è´´åˆ°æäº¤æ¶ˆæ¯ä¸­ï¼Œå¹¶ä¸”è®°ä½è¿™æ ·åšï¼Œè¿™æ˜¯æˆ‘æœ€éš¾ä»¥è§£å†³çš„é—®é¢˜ğŸ˜…ã€‚

å‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘å¼€å§‹å¯»æ±‚äº†è§£git hooksï¼Œè¯•å›¾è‡ªåŠ¨åŒ–è¿™é¡¹ä»»åŠ¡ã€‚æˆ‘çš„æƒ³æ³•æ˜¯èƒ½å¤Ÿä»gitåˆ†æ”¯è·å–JIRAç¼–å·ï¼ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ†æ”¯å‘½åçº¦å®šï¼Œå½¢å¦‚ï¼šstory/ISSUE-1234_branch-nameï¼‰ï¼Œç„¶åå°†æäº¤æ¶ˆæ¯æ›´æ”¹ä¸ºä»¥JIRAç¼–å·ä¸ºå‰ç¼€ï¼Œä»è€Œç”Ÿæˆæœ€ç»ˆç»“æœæ¶ˆæ¯ï¼šISSUE-1234-å…¶ä»–åŸæœ¬çš„æäº¤ä¿¡æ¯ã€‚



# ç”¨git hooksè‡ªåŠ¨ç”Ÿæˆæäº¤ä¿¡æ¯

**[Git Hooks](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)**æä¾›äº†ä¸€ç§åœ¨è¿è¡ŒæŸäº›é‡è¦çš„gitå‘½ä»¤æ—¶è§¦å‘è‡ªå®šä¹‰æ“ä½œçš„æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨ä¸€æ¬¡commitæˆ–è€…pushä¹‹å‰æ‰§è¡Œä¸€äº›æ“ä½œã€‚

åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†**`commit-msg`**é’©å­ï¼Œå®ƒèƒ½å¤Ÿåœ¨å½“å‰æäº¤ä¿¡æ¯ç”Ÿæ•ˆå‰ä¿®æ”¹æ­¤ä¿¡æ¯ã€‚é’©å­ç”±ä¸€ä¸ªå‚æ•°è°ƒç”¨ï¼Œè¯¥å‚æ•°æ˜¯æŒ‡å‘åŒ…å«ç”¨æˆ·è¾“å…¥çš„æäº¤æ¶ˆæ¯çš„æ–‡ä»¶çš„è·¯å¾„ã€‚è¿™æ„å‘³ç€ï¼Œä¸ºäº†æ”¹å˜æäº¤æ¶ˆæ¯ï¼Œæˆ‘ä»¬åªéœ€è¦ä»æ–‡ä»¶ä¸­è¯»å–ã€ä¿®æ”¹å…¶å†…å®¹ï¼Œç„¶åå†™å›è°ƒç”¨æŒ‚é’©çš„æ–‡ä»¶ã€‚

è¦åˆ›å»ºgité’©å­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨**`.git/hooks`**è·¯ç»ä¸‹æä¾›ä¸€ä¸ªå¯æ‰§è¡Œè„šæœ¬ã€‚æˆ‘çš„é’©å­æ”¾åœ¨äº†**`.git/hooks/commit-msg`**è·¯ç»ä¹‹ä¸‹ã€‚



# ä¸ºä»€ä¹ˆæˆ‘ä½¿ç”¨Swiftï¼Ÿ

Git hookså¯ä»¥ä½¿ç”¨ä»»ä½•ä½ ç†Ÿæ‚‰çš„ï¼Œå¹¶ä¸”åœ¨ä¸»æœºä¸Šå®‰è£…äº†è§£é‡Šå™¨ï¼ˆé€šè¿‡`shebang`æ¥æŒ‡å®šï¼‰çš„è„šæœ¬è¯­è¨€æ¥ç¼–å†™ã€‚

è™½ç„¶æœ‰å¾ˆå¤šæ›´å—æ¬¢è¿çš„é€‰é¡¹ï¼Œæ¯”å¦‚`bash`ã€`ruby`ç­‰ç­‰ï¼Œä½†æˆ‘è¿˜æ˜¯å†³å®šä½¿ç”¨Swiftã€‚å› ä¸ºæˆ‘å¯¹Swiftæ›´ç†Ÿæ‚‰ï¼Œå› ä¸ºæˆ‘æ¯å¤©éƒ½åœ¨ä½¿ç”¨å®ƒï¼Œè€Œä¸”æˆ‘çœŸçš„éå¸¸å–œæ¬¢å®ƒå¼ºå¤§çš„ç±»å‹è¯­æ³•ä»¥åŠä½å†…å­˜å ç”¨ã€‚



## è®©æˆ‘ä»¬å¼€å§‹å§

ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„IDEç¼–å†™Swiftè„šæœ¬ã€‚ä½†æ˜¯å¦‚æœä½ æƒ³è¦æœ‰é€‚å½“çš„ä»£ç è¡¥å…¨ä»¥åŠè°ƒè¯•èƒ½åŠ›ï¼Œä½ å¯ä»¥ä¸ºå…¶åˆ›å»ºä¸€ä¸ªXcodeé¡¹ç›®ã€‚ä¸ºæ­¤ï¼Œåœ¨**`macOS`**ä¸‹é€‰æ‹©**`Command Line Tool`**åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚

![åœ¨Xcodeä¸­åˆ›å»ºé¡¹ç›®](Assets/xcode-new-project.png "åœ¨Xcodeä¸­åˆ›å»ºé¡¹ç›®")



åœ¨åˆ›å»ºçš„æ–‡ä»¶é¡¶éƒ¨åŠ ä¸ŠSwift shebangï¼Œå¼•å…¥`Foundation`åº“ã€‚

``` swift
#!/usr/bin/swift
import Foundation
```

è¿™æ ·å½“gitæ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œshebangå°†ç¡®ä¿ä½¿ç”¨æ–‡ä»¶ä½œä¸ºè¾“å…¥æ•°æ®è°ƒç”¨/usr/bin/swiftäºŒè¿›åˆ¶æ–‡ä»¶ã€‚



## ç¼–å†™gité’©å­

é¡¹ç›®å·²ç»å…¨éƒ¨è®¾ç½®å¥½ï¼Œæ‰€ä»¥ç°åœ¨å¯ä»¥ç¼–å†™gitæŒ‚é’©äº†ã€‚è®©æˆ‘ä»¬èµ°å®Œæ‰€æœ‰çš„æ­¥éª¤ã€‚



### æ£€ç´¢æäº¤æ¶ˆæ¯

è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä»è„šæœ¬ä¼ è¿›æ¥çš„å‚æ•°æ£€ç´¢ä¸´æ—¶æäº¤æ–‡ä»¶çš„è·¯å¾„ç„¶åè¯»å–æ–‡ä»¶å†…å®¹ã€‚

```swift
let commitMessageFile = CommandLine.arguments[1]

guard let data = FileManager.default.contents(atPath: commitMessageFile),
      let commitMessage = String(data: data, encoding: .utf8) else {
    exit(1)
}
```

åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ‹¿åˆ°äº†æäº¤æ–‡ä»¶çš„è·¯å¾„ï¼ˆ`git`ä¼ é€’ç»™è„šæœ¬ï¼‰ï¼Œç„¶åé€šè¿‡`FileManagerAPI`è¯»å–äº†æ–‡ä»¶å†…å®¹ã€‚å¦‚æœå› ä¸ºä¸€äº›åŸå› æ£€ç´¢å¤±è´¥äº†ï¼Œæˆ‘ä»¬é€€å‡ºï¼ˆ`exit`ï¼‰è„šæœ¬åŒæ—¶è¿”å›çŠ¶æ€ç `1`ï¼Œè¿™å°†å‘Šè¯‰gitç»ˆæ­¢æ­¤æ¬¡æäº¤ã€‚

---
**æ³¨æ„:**

æ ¹æ®[git hooksæ–‡æ¡£](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)ï¼Œå¦‚æœä»»ä½•é’©å­è„šæœ¬è¿”å›çš„çŠ¶æ€ç å¤§äº`0`ï¼Œå®ƒéƒ½å°†ç»ˆæ­¢å³å°†è¦è¦å‘ç”Ÿçš„æ“ä½œã€‚è¿™å°†åœ¨æœ¬æ–‡åé¢çš„éƒ¨åˆ†ä¸­ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨ä¸éœ€è¦åšä»»ä½•ä¿®æ”¹è€Œä¼˜é›…åœ°é€€å‡ºã€‚

---

### æ£€ç´¢é—®é¢˜ç¼–å·

æ—¢ç„¶æäº¤ä¿¡æ¯çš„å­—ç¬¦ä¸²å·²ç»å¯ç”¨ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦æ‰¾åˆ°å½“å‰åˆ†æ”¯å¹¶ä»ä¸­æ£€ç´¢åˆ°é—®é¢˜ç¼–å·ã€‚æ­£å¦‚æœ¬æ–‡å‰é¢æåˆ°çš„ï¼Œè¿™åªå¯èƒ½æ˜¯å› ä¸ºå›¢é˜Ÿå¯¹åˆ†æ”¯å‘½åçš„ä¸¥æ ¼æ ¼å¼ï¼Œåœ¨å…¶åç§°ä¸­å§‹ç»ˆåŒ…å«JIRAç¼–å·ï¼ˆä¾‹å¦‚ï¼Œ**`story/ISSUE-1234_some-awesome-feature-work`**ï¼‰ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»æ£€ç´¢å½“å‰çš„å·¥ä½œåˆ†æ”¯ï¼Œç„¶åç”¨[æ­£åˆ™è¡¨è¾¾å¼](https://nshipster.com/swift-regular-expressions/)ä»ä¸­æ£€ç´¢é—®é¢˜ç¼–å·ã€‚

è®©æˆ‘ä»¬ä»æ·»åŠ è„šæœ¬è°ƒç”¨`zsh shell`å‘½ä»¤çš„èƒ½åŠ›å¼€å§‹ã€‚é€šè¿‡ä½¿ç”¨`Process`apiï¼Œè„šæœ¬å¯ä»¥ä¸`git`å‘½ä»¤è¡Œç•Œé¢äº¤äº’ã€‚

```swift
func shell(_ command: String) -> String {
    let task = Process()
    let outputPipe = Pipe()
    let errorPipe = Pipe()
    
    task.standardOutput = outputPipe
    task.standardError = errorPipe
    task.arguments = ["-c", command]
    task.executableURL = URL(fileURLWithPath: "/bin/zsh")
    
    do {
        try task.run()
        task.waitUntilExit()
    } catch {
        print("There was an error running the command: \(command)")
        print(error.localizedDescription)
        exit(1)
    }
    
    guard let outputData = try? outputPipe.fileHandleForReading.readToEnd(),
          let outputString = String(data: outputData, encoding: .utf8) else {
        // Print error if needed
        if let errorData = try? errorPipe.fileHandleForReading.readToEnd(),
           let errorString = String(data: errorData, encoding: .utf8) {
            print("Encountered the following error running the command:")
            print(errorString)
        }
        exit(1)
    }
    
    return outputString
}
```

ç°åœ¨å®ç°äº†`shell`å‘½ä»¤ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å®ƒè¯¢é—®`git`å½“å‰åˆ†æ”¯æ˜¯ä»€ä¹ˆï¼Œç„¶åå°½å¯èƒ½çš„ä»ä¸­æå–å‡ºé—®é¢˜ç¼–å·ã€‚

```swift
let gitBranchName = shell("git rev-parse --abbrev-ref HEAD")
    .trimmingCharacters(in: .newlines)

let stringRange = NSRange(location: 0, length: gitBranchName.utf16.count)

guard let regex = try? NSRegularExpression(pattern: #"(\w*-\d*)"#, options: .anchorsMatchLines),
    let match = regex.firstMatch(in: gitBranchName, range: stringRange) else {
    exit(0)
}

let range = match.range(at: 1)

let ticketNumber = (gitBranchName as NSString)
    .substring(with: range)
    .trimmingCharacters(in: .newlines)
```

è¯·æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…é¡¹ï¼ˆå³åˆ†æ”¯åç§°ä¸­ä¸åŒ…å«JIRAé—®é¢˜ç¼–å·ï¼‰ï¼Œè„šæœ¬å°†ä»¥0çš„çŠ¶æ€é€€å‡ºï¼Œå…è®¸æäº¤ç»§ç»­è¿›è¡Œï¼Œè€Œä¸è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚è¿™æ˜¯ä¸ºäº†ä¸ç ´åè¯¸å¦‚mainæˆ–å…¶ä»–æµ‹è¯•/è°ƒæŸ¥åˆ†æ”¯ä¸­çš„å·¥ä½œæµã€‚



### ä¿®æ”¹æäº¤ä¿¡æ¯

ä¸ºäº†æ›´æ”¹æäº¤æ¶ˆæ¯ï¼Œå¿…é¡»å°†è„šæœ¬å¼€å¤´è¯»å–çš„æ–‡ä»¶å†…å®¹ï¼ˆåŒ…å«æäº¤æ¶ˆæ¯ï¼‰å†™å›åŒä¸€è·¯å¾„ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªéœ€è¦åšä¸€ä¸ªæ›´æ”¹ï¼Œå³åœ¨æäº¤ä¿¡æ¯çš„å‰é¢åŠ ä¸ŠJIRAç¼–å·å’Œï¼ˆ-ï¼‰ï¼Œä»¥å°†å…¶ä¸æäº¤ä¿¡æ¯çš„å…¶ä½™éƒ¨åˆ†å¾ˆå¥½åœ°åˆ†å¼€ã€‚è¿˜å¿…é¡»ç¡®ä¿æ£€æŸ¥äº†æäº¤ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œä»…åœ¨ç¼–å·ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ ç¼–å·ï¼š

```swift
if !commitMessage.contains(ticketNumber) {
    do {
        try "\(ticketNumber) - \(commitMessage.trimmingCharacters(in: .newlines))"
            .write(toFile: commitMessageFile, atomically: true, encoding: .utf8)
    } catch {
        print("Could not write to file \(commitMessageFile)")
        exit(1)
    }
}
```



### è®¾ç½®gité’©å­

ç°åœ¨è„šæœ¬å·²ç»å‡†å¤‡å¥½äº†ï¼Œæ˜¯æ—¶å€™æŠŠå®ƒæ”¾åœ¨gitå¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®äº†ã€‚Gité’©å­å¯ä»¥å…¨å±€è®¾ç½®ï¼Œä¹Ÿå¯ä»¥åŸºäºå•ä¸ªrepoè®¾ç½®ã€‚

æˆ‘ä¸ªäººå¯¹è¿™ç±»è„šæœ¬çš„åå¥½æ˜¯åŸºäºå•ä¸ªrepoè®¾ç½®ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥åœ¨å‡ºç°é—®é¢˜æ—¶ä¸ºæ‚¨æä¾›æ›´å¤šçš„æ§åˆ¶å’Œå¯è§æ€§ï¼Œå¹¶ä¸”å¦‚æœé’©å­å¼€å§‹å¤±è´¥ï¼Œå®ƒä¼šåœ¨å®ƒè®¾ç½®çš„repoä¸­å¤±è´¥ï¼Œè€Œä¸æ˜¯å…¨å±€éƒ½å¤±è´¥ã€‚

è¦è®¾ç½®å®ƒä»¬ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿æ–‡ä»¶å¯æ‰§è¡Œï¼Œé‡å‘½åå¹¶å°†å…¶å¤åˆ¶åˆ°æ‰€è¦è®¾ç½®repoçš„**`.git/hooks/`**è·¯å¾„ä¹‹ä¸‹ï¼š

```shell
chmod +x main.swift
mv main.swift <path_to_your_repo>/.git/hooks/commit-msg
```



# æµ‹è¯•ç»“æœ

ç°åœ¨repoå·²ç»å…¨éƒ¨è®¾ç½®å¥½äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯å¯¹éƒ¨ç½²çš„è„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚åœ¨ä¸‹é¢çš„æˆªå±ä¸­ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªå¸¦æœ‰é—®é¢˜ç¼–å·ï¼Œä¸€ä¸ªæ²¡æœ‰ï¼Œå®ƒä»¬æœ‰ç€ç›¸åŒçš„æäº¤ä¿¡æ¯ã€‚å¯ä»¥çœ‹å‡ºè„šæœ¬è¿è¡Œæ­£å¸¸ï¼Œå¹¶ä¸”åªåœ¨éœ€è¦æ—¶æ‰æ›´æ”¹æäº¤æ¶ˆæ¯ï¼

![æµ‹è¯•ç»“æœ](Assets/git-hook-output.png "æµ‹è¯•ç»“æœ")